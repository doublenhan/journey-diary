rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // Helper Functions - V3.0
    // ===========================
    
    // Kiểm tra user đã đăng nhập chưa
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Kiểm tra user có phải chủ sở hữu không
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Kiểm tra user có role SysAdmin không (for dev environment)
    function isSysAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/dev_users/$(request.auth.uid)).data.role == 'SysAdmin';
    }
    
    // Kiểm tra user có role SysAdmin không (for production environment)
    function isSysAdminProd() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SysAdmin';
    }
    
    // Kiểm tra user có status Active (or không có status field - backward compatibility)
    function isActiveUser() {
      return isAuthenticated() && (
        !('status' in get(/databases/$(database)/documents/dev_users/$(request.auth.uid)).data) ||
        get(/databases/$(database)/documents/dev_users/$(request.auth.uid)).data.status == 'Active'
      );
    }
    
    // Kiểm tra user có status Active (for production environment)
    function isActiveUserProd() {
      return isAuthenticated() && (
        !('status' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data) ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'Active'
      );
    }
    
    // Validate mã ngôn ngữ
    function isValidLanguage() {
      return !('language' in request.resource.data) || 
             request.resource.data.language in ['vi', 'en'];
    }
    
    // Validate string with min/max length
    function isValidString(str, minLength, maxLength) {
      return str is string 
        && str.size() >= minLength 
        && str.size() <= maxLength;
    }
    
    // Validate timestamp is recent (within 1 minute of server time)
    function isRecentTimestamp(ts) {
      return ts is timestamp
        && ts > request.time - duration.value(1, 'm')
        && ts < request.time + duration.value(1, 'm');
    }
    
    // Validate Memory data structure - Enhanced
    function isValidMemory() {
      let data = request.resource.data;
      return data.userId is string
        && isValidString(data.title, 1, 200)
        && data.photos is list
        && data.photos.size() >= 1
        && data.photos.size() <= 10
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }
    
    // Validate Memory on create - stricter validation
    function isValidMemoryCreate() {
      let data = request.resource.data;
      return isValidMemory()
        && data.createdAt == data.updatedAt
        && isRecentTimestamp(data.createdAt);
    }
    
    // Validate Memory on update - prevent critical changes
    function isValidMemoryUpdate() {
      let data = request.resource.data;
      let oldData = resource.data;
      return isValidMemory()
        && data.userId == oldData.userId
        && data.createdAt == oldData.createdAt
        && data.updatedAt > oldData.updatedAt
        && isRecentTimestamp(data.updatedAt);
    }
    
    // Validate Anniversary data structure
    function isValidAnniversary() {
      let data = request.resource.data;
      return data.userId is string
        && data.title is string
        && data.title.size() <= 200
        && data.date is string;
    }
    
    // ===========================
    // User Collections
    // ===========================
    
    // Dev Users collection (development environment)
    // Stores: displayName, email, phone, dob, language
    // Dev Users - Development environment
    // Stores: displayName, email, phone, dob, language, role
    match /dev_users/{userId} {
      // Users can read their own doc
      // Authenticated users can read all users (for admin panel)
      allow read: if isOwner(userId) || isAuthenticated();
      // Users can update their own profile (except role and status)
      allow update: if isOwner(userId) && isValidLanguage() && !('role' in request.resource.data.diff(resource.data).affectedKeys()) && !('status' in request.resource.data.diff(resource.data).affectedKeys());
      // Users can delete their own account (Active → Removed)
      allow update: if isOwner(userId) 
        && resource.data.status == 'Active' 
        && request.resource.data.status == 'Removed'
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'removedAt', 'statusUpdatedAt', 'statusUpdatedBy']);
      // Only SysAdmin can change role
      allow update: if isSysAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'updatedAt', 'roleChangedAt', 'roleChangedBy']);
      // SysAdmin can restore account (Removed → Active)
      allow update: if isSysAdmin() 
        && resource.data.status == 'Removed'
        && request.resource.data.status == 'Active'
        && request.resource.data.keys().hasAll(['status', 'statusUpdatedAt', 'statusUpdatedBy', 'restoredAt', 'restoredBy'])
        && !('removedAt' in request.resource.data);
      // Only SysAdmin can change status
      allow update: if isSysAdmin() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusUpdatedAt', 'statusUpdatedBy']);
      // Users can create their own doc
      allow create: if isOwner(userId) && isValidLanguage();
      
      // Calendar subcollection - users can manage their own calendars
      match /calendar/{year} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // Production Users collection
    // Stores: displayName, email, phone, dob, language, role
    match /users/{userId} {
      // Users can read their own doc
      // Authenticated users can read all users (for admin panel)
      allow read: if isOwner(userId) || isAuthenticated();
      // Users can update their own profile (except role and status)
      allow update: if isOwner(userId) && isValidLanguage() && !('role' in request.resource.data.diff(resource.data).affectedKeys()) && !('status' in request.resource.data.diff(resource.data).affectedKeys());
      // Users can delete their own account (Active → Removed)
      allow update: if isOwner(userId) 
        && resource.data.status == 'Active' 
        && request.resource.data.status == 'Removed'
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'removedAt', 'statusUpdatedAt', 'statusUpdatedBy']);
      // Only SysAdmin can change role
      allow update: if isSysAdminProd() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['role', 'updatedAt', 'roleChangedAt', 'roleChangedBy']);
      // SysAdmin can restore account (Removed → Active)
      allow update: if isSysAdminProd() 
        && resource.data.status == 'Removed'
        && request.resource.data.status == 'Active'
        && request.resource.data.keys().hasAll(['status', 'statusUpdatedAt', 'statusUpdatedBy', 'restoredAt', 'restoredBy'])
        && !('removedAt' in request.resource.data);
      // Only SysAdmin can change status
      allow update: if isSysAdminProd() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'statusUpdatedAt', 'statusUpdatedBy']);
      // Users can create their own doc
      allow create: if isOwner(userId) && isValidLanguage();
      
      // Calendar subcollection - users can manage their own calendars
      match /calendar/{year} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ===========================
    // Memories Collections - V3.0 Enhanced Security
    // ===========================
    
    // Dev Memories - Development environment
    match /dev_memories/{memoryId} {
      allow read, list: if isActiveUser();
      allow write: if isActiveUser() && request.auth.uid == request.resource.data.userId;
      allow delete: if isActiveUser() && request.auth.uid == resource.data.userId;
    }
    
    // Production Memories - Enhanced security
    match /memories/{memoryId} {
      allow read, list: if isActiveUserProd();
      allow write: if isActiveUserProd() && request.auth.uid == request.resource.data.userId;
      allow delete: if isActiveUserProd() && request.auth.uid == resource.data.userId;
    }
    
    // ===========================
    // Anniversary Collections - V3.0 Enhanced Security
    // ===========================
    
    // Dev Anniversary Events
    match /dev_AnniversaryEvent/{eventId} {
      // Allow all active users to read (filter by userId in client)
      allow read: if isActiveUser();
      allow create: if isActiveUser() 
        && isOwner(request.resource.data.userId)
        && isValidAnniversary();
      allow update: if isActiveUser() && isOwner(resource.data.userId);
      allow delete: if isActiveUser() && isOwner(resource.data.userId);
    }
    
    // Production Anniversary Events
    match /AnniversaryEvent/{eventId} {
      // Allow all active users to read (filter by userId in client)
      allow read: if isActiveUserProd();
      allow create: if isActiveUserProd() 
        && isOwner(request.resource.data.userId)
        && isValidAnniversary();
      allow update: if isActiveUserProd() && isOwner(resource.data.userId);
      allow delete: if isActiveUserProd() && isOwner(resource.data.userId);
    }
    
    // ===========================
    // User Effects Collections
    // ===========================
    
    match /dev_userEffects/{userId} {
      allow read, write: if isActiveUser() && isOwner(userId);
    }
    
    match /userEffects/{userId} {
      allow read, write: if isActiveUserProd() && isOwner(userId);
    }
    
    // ===========================
    // Couple Features Collections
    // ===========================
    
    // Helper functions for couple features
    function isCoupleParticipant(coupleData) {
      return isAuthenticated() && (
        request.auth.uid == coupleData.user1Id ||
        request.auth.uid == coupleData.user2Id
      );
    }
    
    function isInvitationSender(invitationData) {
      return isAuthenticated() && request.auth.uid == invitationData.senderId;
    }
    
    function isInvitationReceiver(invitationData) {
      return isAuthenticated() && request.auth.uid == invitationData.receiverId;
    }
    
    function isInvitationParty(invitationData) {
      return isInvitationSender(invitationData) || isInvitationReceiver(invitationData);
    }
    
    // Development Couples Collection
    match /dev_couples/{coupleId} {
      // Allow list/query if authenticated (query will filter by user1Id or user2Id)
      // Allow get only if user is participant
      allow list: if isAuthenticated();
      allow get: if isCoupleParticipant(resource.data);
      allow create: if isAuthenticated() && (
        request.auth.uid == request.resource.data.user1Id ||
        request.auth.uid == request.resource.data.user2Id
      );
      allow update: if isCoupleParticipant(resource.data) && (
        request.resource.data.user1Id == resource.data.user1Id &&
        request.resource.data.user2Id == resource.data.user2Id &&
        request.resource.data.coupleId == resource.data.coupleId
      );
      allow delete: if isCoupleParticipant(resource.data);
    }
    
    // Couples Collection
    match /couples/{coupleId} {
      // Allow list/query if authenticated (query will filter by user1Id or user2Id)
      // Allow get only if user is participant
      allow list: if isAuthenticated();
      allow get: if isCoupleParticipant(resource.data);
      
      // Create: Will be created by Cloud Function after invitation acceptance
      // Allow users to create if they are one of the participants
      allow create: if isAuthenticated() && (
        request.auth.uid == request.resource.data.user1Id ||
        request.auth.uid == request.resource.data.user2Id
      );
      
      // Update: Only couple participants can update settings
      allow update: if isCoupleParticipant(resource.data) && (
        // Ensure user IDs don't change
        request.resource.data.user1Id == resource.data.user1Id &&
        request.resource.data.user2Id == resource.data.user2Id &&
        request.resource.data.coupleId == resource.data.coupleId
      );
      
      // Delete/Disconnect: Only couple participants can delete
      allow delete: if isCoupleParticipant(resource.data);
    }
    
    // Development Couple Invitations Collection
    match /dev_coupleInvitations/{invitationId} {
      allow read: if isInvitationParty(resource.data);
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId &&
        request.resource.data.status == 'pending';
      allow update: if (
        (isInvitationReceiver(resource.data) && 
         resource.data.status == 'pending' &&
         request.resource.data.status in ['accepted', 'rejected']) ||
        (isInvitationSender(resource.data) && 
         resource.data.status == 'pending' &&
         request.resource.data.status == 'expired')
      );
      allow delete: if isInvitationParty(resource.data);
    }
    
    // Couple Invitations Collection
    match /coupleInvitations/{invitationId} {
      // Read: Sender and receiver can read their invitations
      allow read: if isInvitationParty(resource.data);
      
      // Create: Any authenticated user can send invitation
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId &&
        request.resource.data.status == 'pending';
      
      // Update: Receiver can accept/reject, Sender can cancel
      allow update: if (
        // Receiver accepting/rejecting
        (isInvitationReceiver(resource.data) && 
         resource.data.status == 'pending' &&
         request.resource.data.status in ['accepted', 'rejected']) ||
        // Sender canceling
        (isInvitationSender(resource.data) && 
         resource.data.status == 'pending' &&
         request.resource.data.status == 'expired')
      );
      
      // Delete: Sender can delete their sent invitation, or receiver can delete after response
      allow delete: if isInvitationParty(resource.data);
    }
    
    // Development Shared Memories Collection
    match /dev_sharedMemories/{sharedId} {
      // Get single document: Owner or partner can read
      allow get: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid == resource.data.sharedWithId
      );
      
      // List/Query: Allow if authenticated (client filters by userId)
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.ownerId &&
        request.auth.uid == request.resource.data.sharedBy;
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
    }
    
    // Shared Memories Collection
    match /sharedMemories/{sharedId} {
      // Get single document: Owner or partner can read
      allow get: if isAuthenticated() && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid == resource.data.sharedWithId
      );
      
      // List/Query: Allow if authenticated (client filters by userId)
      allow list: if isAuthenticated();
      
      // Create: Only memory owner can share
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.ownerId &&
        request.auth.uid == request.resource.data.sharedBy;
      
      // Update: Only owner can update (e.g., revoke)
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
      
      // Delete: Only owner can delete (unshare)
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
    }
    
    // ===========================
    // Albums Collection - V3.1
    // ===========================
    
    // Albums - Production environment
    match /albums/{albumId} {
      // Read: Owner can read their own albums
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Create: User can create albums for themselves
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.title is string &&
        request.resource.data.title.size() > 0 &&
        request.resource.data.title.size() <= 100;
      
      // Update: Owner can update their own albums
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.userId &&
        request.auth.uid == request.resource.data.userId;
      
      // Delete: Owner can delete their own albums
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
    }
    
    // Albums - Development environment
    match /dev_albums/{albumId} {
      // Read: Owner can read their own albums
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Create: User can create albums for themselves
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.title is string &&
        request.resource.data.title.size() > 0 &&
        request.resource.data.title.size() <= 100;
      
      // Update: Owner can update their own albums
      allow update: if isAuthenticated() && 
        request.auth.uid == resource.data.userId &&
        request.auth.uid == request.resource.data.userId;
      
      // Delete: Owner can delete their own albums
      allow delete: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
    }
    
    // ===========================
    // System Statistics Collection
    // ===========================
    
    // System stats - Read-only for authenticated users, write by Cloud Functions
    // Support both production (no prefix) and dev (dev_ prefix)
    match /system_stats/{statId} {
      // All authenticated users can read system stats
      allow read: if isAuthenticated();
      // Only allow writes from Cloud Functions (no client writes)
      allow write: if false;
    }
    
    match /dev_system_stats/{statId} {
      // All authenticated users can read system stats
      allow read: if isAuthenticated();
      // Only allow writes from Cloud Functions (no client writes)
      allow write: if false;
    }
    
    // Cron History - Detailed 24h execution records
    match /cron_history/{historyId} {
      // Only SysAdmin can read cron history
      allow read: if isSysAdmin() || isSysAdminProd();
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    match /dev_cron_history/{historyId} {
      // Only SysAdmin can read cron history
      allow read: if isSysAdmin() || isSysAdminProd();
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // Cron Stats Daily - 7-day aggregated summary
    match /cron_stats_daily/{statsId} {
      // Only SysAdmin can read daily stats
      allow read: if isSysAdmin() || isSysAdminProd();
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    match /dev_cron_stats_daily/{statsId} {
      // Only SysAdmin can read daily stats
      allow read: if isSysAdmin() || isSysAdminProd();
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // ===========================
    // Default Deny - Security Best Practice
    // ===========================
    
    // Từ chối tất cả truy cập khác không được định nghĩa ở trên
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
