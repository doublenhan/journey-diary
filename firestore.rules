rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // Helper Functions - V3.0
    // ===========================
    
    // Kiểm tra user đã đăng nhập chưa
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Kiểm tra user có phải chủ sở hữu không
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate mã ngôn ngữ
    function isValidLanguage() {
      return !('language' in request.resource.data) || 
             request.resource.data.language in ['vi', 'en'];
    }
    
    // Validate string with min/max length
    function isValidString(str, minLength, maxLength) {
      return str is string 
        && str.size() >= minLength 
        && str.size() <= maxLength;
    }
    
    // Validate timestamp is recent (within 1 minute of server time)
    function isRecentTimestamp(ts) {
      return ts is timestamp
        && ts > request.time - duration.value(1, 'm')
        && ts < request.time + duration.value(1, 'm');
    }
    
    // Validate Memory data structure - Enhanced
    function isValidMemory() {
      let data = request.resource.data;
      return data.userId is string
        && isValidString(data.title, 1, 200)
        && data.photos is list
        && data.photos.size() >= 1
        && data.photos.size() <= 10
        && data.createdAt is timestamp
        && data.updatedAt is timestamp;
    }
    
    // Validate Memory on create - stricter validation
    function isValidMemoryCreate() {
      let data = request.resource.data;
      return isValidMemory()
        && data.createdAt == data.updatedAt
        && isRecentTimestamp(data.createdAt);
    }
    
    // Validate Memory on update - prevent critical changes
    function isValidMemoryUpdate() {
      let data = request.resource.data;
      let oldData = resource.data;
      return isValidMemory()
        && data.userId == oldData.userId
        && data.createdAt == oldData.createdAt
        && data.updatedAt > oldData.updatedAt
        && isRecentTimestamp(data.updatedAt);
    }
    
    // Validate Anniversary data structure
    function isValidAnniversary() {
      let data = request.resource.data;
      return data.userId is string
        && data.title is string
        && data.title.size() <= 200
        && data.date is string;
    }
    
    // ===========================
    // User Collections
    // ===========================
    
    // Dev Users collection (development environment)
    // Stores: displayName, email, phone, dob, language
    // Dev Users - Development environment
    // Stores: displayName, email, phone, dob, language, role
    match /dev_users/{userId} {
      // Users can read their own doc
      // Authenticated users can read all users (for admin panel)
      allow read: if isOwner(userId) || isAuthenticated();
      allow write: if isOwner(userId) && isValidLanguage();
    }
    
    // Production Users collection
    // Stores: displayName, email, phone, dob, language, role
    match /users/{userId} {
      // Users can read their own doc
      // Authenticated users can read all users (for admin panel)
      allow read: if isOwner(userId) || isAuthenticated();
      allow write: if isOwner(userId) && isValidLanguage();
    }
    
    // ===========================
    // Memories Collections - V3.0 Enhanced Security
    // ===========================
    
    // Dev Memories - Development environment
    match /dev_memories/{memoryId} {
      // Chỉ đọc memories của mình
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      // Tạo mới: phải validate data + là owner + stricter checks
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isValidMemoryCreate();
      // Update: phải là owner + validate data + prevent critical changes
      allow update: if isAuthenticated() 
        && isOwner(resource.data.userId)
        && isValidMemoryUpdate();
      // Delete: chỉ owner mới xóa được
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Production Memories - Enhanced security
    match /memories/{memoryId} {
      // Chỉ đọc memories của mình
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      // Tạo mới: phải validate data + là owner + stricter checks
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isValidMemoryCreate();
      // Update: phải là owner + validate data + prevent critical changes
      allow update: if isAuthenticated() 
        && isOwner(resource.data.userId)
        && isValidMemoryUpdate();
      // Delete: chỉ owner mới xóa được
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // ===========================
    // Anniversary Collections - V3.0 Enhanced Security
    // ===========================
    
    // Dev Anniversary Events
    match /dev_AnniversaryEvent/{eventId} {
      // Allow all authenticated users to read (filter by userId in client)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isValidAnniversary();
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Production Anniversary Events
    match /AnniversaryEvent/{eventId} {
      // Allow all authenticated users to read (filter by userId in client)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() 
        && isOwner(request.resource.data.userId)
        && isValidAnniversary();
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // ===========================
    // User Effects Collections
    // ===========================
    
    match /dev_userEffects/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    match /userEffects/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // ===========================
    // System Statistics Collection
    // ===========================
    
    // System stats - Read-only for authenticated users, write by Cloud Functions
    match /system_stats/{statId} {
      // All authenticated users can read system stats
      allow read: if isAuthenticated();
      // Only allow writes from Cloud Functions (no client writes)
      allow write: if false;
    }
    
    // ===========================
    // Default Deny - Security Best Practice
    // ===========================
    
    // Từ chối tất cả truy cập khác không được định nghĩa ở trên
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
